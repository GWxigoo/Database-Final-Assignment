from pymongo import MongoClient
import pandas as pd
import numpy as np

from sklearn.model_selection import train_test_split
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.linear_model import LogisticRegression
from sklearn.metrics import accuracy_score, precision_score, recall_score, f1_score

from xgboost import XGBClassifier

import tensorflow as tf
from tensorflow.keras import layers, Model
import pickle

MONGO_URI = <private_connection_string>

client = MongoClient(MONGO_URI)
db = client["sqli_detection_db"]

queries_col = db["sql_queries"]
results_col = db["sql_prediction_results"]

print("âœ… MongoDB connected")

docs = list(queries_col.find({}, {"_id": 0}))
df = pd.DataFrame(docs)

RULE_FEATURES = [
    "query_len","is_boolean","always_true","is_union","is_comment",
    "is_time_based","comparison_op_count","parentheses_depth",
    "logic_operator_count","str_count","num_count"
]

df["text"] = df["filtered_tokens"].apply(lambda x: " ".join(x))
X_feat = pd.DataFrame(df["rule_features"].tolist())[RULE_FEATURES].values
y = df["true_label"].values
